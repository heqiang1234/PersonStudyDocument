# 消息队列的持久化

## 1、持久化

将数据存入磁盘，而不是存在内存中随服务器重启断开而消失，使数据能够永久保存

## 2、持久化方式

文件的方式进行存储

# 消息队列的分发

在发送消息的过程中可能会出现异常，或者网络的抖动，故障等等因为造成消息的无法消费，比如用户在下订单，消息MQ接受，订单系统出现故障，导致用户出现支付失败，那么这个时候就需要消息中间件必须支持消息重试机制策略，也就是支持：出现问题和故障的情况下，消息不丢失还可以进行重发。

## 消息分发策略的机制和对比

<img title="" src="file:///C:/Users/hspcadmin/AppData/Roaming/marktext/images/2022-03-25-20-21-13-(OT)CQ6XQT(PU5[P[VZSB]5.png" alt="" data-align="inline">

# 消息队列高可用和高可靠

## 什么是高可用机制

所谓高可用：是指产品在规定的条件和规定的时刻或时间内存于可执行规定功能状态的能力。

当业务量增加时，请求也过大，一台消息中间件服务器会触及硬件（CPU、内存、磁盘）的极限，一台消息服务器已经无法满足业务的需求，所以消息中间件必须支持集群部署，来达到高可用的目的。



## 集群模式1 - Master-salve主从共享数据的部署方式

生产者将消息发送到Master中，所有的连接这个消息队列共享这个数据区域， Master节点负责写入，一旦Master节点挂了，slave节点继续服务，从而形成高可用。



## 集群部署2 - Master -slave 主从部署方式

这种模式写入消息同样是Master主节点上，但是主节点会同步数据到slave节点上，有些像mysql主从复制，zookeeper或者redis主从机制，可以达到负载均衡的效果，如果多个这样就可以不同节点去消费，因为消息的拷贝和同步会占用很大的带宽和网络资源。在后续的rabbitmq中会有使用。



## 集群部署3 - 多主集群同步部署模式

写入可以往任意节点去写入



## 集群部署4 - 多主集群转发部署模式





## 集群部署5 - Master-slave与reoker-cluster组合的方案

2. 要么消息共享

3. 要么消息同步

4. 要么元数据共享



# 消息的可靠性机制

系统可以无故障的持续运行，比如一个系统突然崩溃，报错，异常等并不影响线上业务的正常运行，出错的机率极低，称之为：高可靠。

在高并发的业务场景中，如果不能保障系统的高可靠，那么造成的隐患和损失是非常严重的

如何保证中间件消息的可靠性呢？可以从两个方面考虑：

1. 消息的传输：通过协议来保证系统间数据解析的正确性。

2. 消息的存储可靠：通过持久化来保证消息的正确性。
